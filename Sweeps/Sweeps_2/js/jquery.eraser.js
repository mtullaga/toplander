!function(e){var t={init:function(o){return this.each(function(){var a=e(this),n=a.data("eraser");if(!n){var i=function(){var i=e("<canvas/>"),r=i.get(0),s=r.getContext("2d"),c=(window.devicePixelRatio||1)/(s.webkitBackingStorePixelRatio||s.mozBackingStorePixelRatio||s.msBackingStorePixelRatio||s.oBackingStorePixelRatio||s.backingStorePixelRatio||1),u=a.width(),l=a.height(),h=u*c,d=l*c,p=a.offset(),f=!o||!1!==o.enabled,v=(o&&o.size?o.size:40)*c,m=o&&o.completeRatio?o.completeRatio:.7,g=o&&o.completeFunction?o.completeFunction:null,x=o&&o.progressFunction?o.progressFunction:null,b="auto"==a.css("z-index")?1:a.css("z-index"),w=[],P=Math.floor(h/v),z=P*Math.floor(d/v),D=z,R=a[0];for(a.after(i),r.id=R.id,r.className=R.className,r.width=h,r.height=d,r.style.width=u.toString()+"px",r.style.height=l.toString()+"px",s.drawImage(R,0,0,h,d),a.remove(),s.globalCompositeOperation="destination-out",s.strokeStyle="rgba(255,0,0,255)",s.lineWidth=v,s.lineCap="round",i.bind("mousedown.eraser",t.mouseDown),i.bind("touchstart.eraser",t.touchStart),i.bind("touchmove.eraser",t.touchMove),i.bind("touchend.eraser",t.touchEnd);D--;)w.push(1);n={posX:p.left,posY:p.top,touchDown:!1,touchID:-999,touchX:0,touchY:0,ptouchX:0,ptouchY:0,canvas:i,ctx:s,w:h,h:d,scaleRatio:c,source:R,size:v,parts:w,colParts:P,numParts:z,ratio:0,enabled:f,complete:!1,completeRatio:m,completeFunction:g,progressFunction:x,zIndex:b},i.data("eraser",n),e(window).resize(function(){var e=i.offset();n.posX=e.left,n.posY=e.top})};this.complete&&this.naturalWidth>0?i():a.on("load",i)}})},touchStart:function(o){var a=e(this).data("eraser");if(!a.touchDown){var n=o.originalEvent.changedTouches[0],i=n.pageX-a.posX,r=n.pageY-a.posY;i*=a.scaleRatio,r*=a.scaleRatio,a.enabled&&t.evaluatePoint(a,i,r),a.touchDown=!0,a.touchID=n.identifier,a.touchX=i,a.touchY=r,o.preventDefault()}},touchMove:function(o){var a=e(this),n=a.data("eraser");if(n.touchDown)for(var i=o.originalEvent.changedTouches,r=i.length;r--;)if(i[r].identifier==n.touchID){var s=i[r].pageX-n.posX,c=i[r].pageY-n.posY;s*=n.scaleRatio,c*=n.scaleRatio,n.enabled&&(t.evaluatePoint(n,s,c),n.ctx.beginPath(),n.ctx.moveTo(n.touchX,n.touchY),n.ctx.lineTo(s,c),n.ctx.stroke(),a.css({"z-index":a.css("z-index")==n.zIndex?parseInt(n.zIndex)+1:n.zIndex})),n.touchX=s,n.touchY=c,o.preventDefault();break}},touchEnd:function(t){var o=e(this).data("eraser");if(o.touchDown)for(var a=t.originalEvent.changedTouches,n=a.length;n--;)if(a[n].identifier==o.touchID){o.touchDown=!1,t.preventDefault();break}},evaluatePoint:function(e,t,o){if(e.enabled){var a=Math.floor(t/e.size)+Math.floor(o/e.size)*e.colParts;a>=0&&a<e.numParts&&(e.ratio+=e.parts[a],e.parts[a]=0,e.complete||((a=e.ratio/e.numParts)>=e.completeRatio?(e.complete=!0,null!=e.completeFunction&&e.completeFunction()):null!=e.progressFunction&&e.progressFunction(a)))}},mouseDown:function(o){var a=e(this),n=a.data("eraser"),i=o.pageX-n.posX,r=o.pageY-n.posY;i*=n.scaleRatio,r*=n.scaleRatio,n.touchDown=!0,n.touchX=i,n.touchY=r,n.enabled&&(t.evaluatePoint(n,i,r),n.ctx.beginPath(),n.ctx.moveTo(n.touchX-1,n.touchY),n.ctx.lineTo(n.touchX,n.touchY),n.ctx.stroke()),a.bind("mousemove.eraser",t.mouseMove),e(document).bind("mouseup.eraser",n,t.mouseUp),o.preventDefault()},mouseMove:function(o){var a=e(this),n=a.data("eraser"),i=o.pageX-n.posX,r=o.pageY-n.posY;i*=n.scaleRatio,r*=n.scaleRatio,n.enabled&&(t.evaluatePoint(n,i,r),n.ctx.beginPath(),n.ctx.moveTo(n.touchX,n.touchY),n.ctx.lineTo(i,r),n.ctx.stroke(),a.css({"z-index":a.css("z-index")==n.zIndex?parseInt(n.zIndex)+1:n.zIndex})),n.touchX=i,n.touchY=r,o.preventDefault()},mouseUp:function(t){var o=t.data,a=o.canvas;o.touchDown=!1,a.unbind("mousemove.eraser"),e(document).unbind("mouseup.eraser"),t.preventDefault()},clear:function(){var t=e(this).data("eraser");if(t){t.ctx.clearRect(0,0,t.w,t.h);for(var o=t.numParts;o--;)t.parts[o]=0;t.ratio=t.numParts,t.complete=!0,null!=t.completeFunction&&t.completeFunction()}},enabled:function(){var t=e(this).data("eraser");return!(!t||!t.enabled)},enable:function(){var t=e(this).data("eraser");t&&(t.enabled=!0)},disable:function(){var t=e(this).data("eraser");t&&(t.enabled=!1)},size:function(t){var o=e(this).data("eraser");o&&t&&(o.size=t,o.ctx.lineWidth=t)},reset:function(){var t=e(this).data("eraser");if(t){t.ctx.globalCompositeOperation="source-over",t.ctx.drawImage(t.source,0,0,t.w,t.h),t.ctx.globalCompositeOperation="destination-out";for(var o=t.numParts;o--;)t.parts[o]=1;t.ratio=0,t.complete=!1,t.touchDown=!1}},progress:function(){var t=e(this).data("eraser");return t?t.ratio/t.numParts:0}};e.fn.eraser=function(o){return t[o]?t[o].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof o&&o?void e.error("Method "+o+" does not yet exist on jQuery.eraser"):t.init.apply(this,arguments)}}(jQuery);